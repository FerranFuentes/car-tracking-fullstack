# Imagen base
FROM node:14.18.1

# Establecer el directorio de trabajo
WORKDIR /app

# Copiar los archivos necesarios
COPY package*.json ./
COPY truffle-config.js ./
COPY contracts ./contracts
COPY migrations ./migrations
COPY src ./src
COPY bs-config.json ./
COPY ganache-2.7.0-linux-x86_64.AppImage .

# Convertir el archivo AppImage en un ejecutable y otorgarle permisos de ejecución
RUN chmod +x ganache-2.7.0-linux-x86_64.AppImage && ./ganache-2.7.0-linux-x86_64.AppImage --appimage-extract && mv squashfs-root /ganache && ln -s /ganache/ganache /usr/local/bin/ganache

# Instalar Truffle
RUN npm install -g truffle@5.4.23

# Instalar las dependencias
RUN npm install

# Exponer el puerto necesario para la aplicación
EXPOSE 3000 7545 8545

# Ejecutar el ganache
CMD ganache -p 7545 -i 5777 -h 0.0.0.0 -m "tu frase semilla de ganache" -n 10 --db /ganache-data

# Esperar a que Ganache se inicie correctamente
RUN sleep 5

# Compilar contratos
RUN truffle compile

# Ejecutar el comando "truffle migrate" para migrar los contratos a la red de Ganache
RUN truffle migrate --network development --reset

# Comando a ejecutar al arrancar el contenedor
CMD ["npm", "run", "dev"]